# Here we build the yara.node binary, package it and copy it to the repository.
# Both MacOS and Linux (Debian-based) versions are built here.
name: Build the binary

on:
  push:
    branches: [ master ]
  pull_request:

  # we're going to build and commit fresh binaries when a new release is published
  release:
    types: [created]

# allow these jobs to commit to the repository
permissions:
  contents: write

jobs:
  # We need to use the node-yara binary on Debian 10.x machines
  # hence we're using the container to build it
  build-debian:
    strategy:
      fail-fast: false
      matrix:
        node-version:
        - '16'
        - '18'
        - '20'

    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v3

    - name: Build binaries inside the container
      run: |
        set -x
        node -v

        # what's the package version?
        # e.g.  Binary staged at "build/stage/Automattic/node-yara/raw/master/binaries/yara-v2.5.0-linux-x64.tar.gz"
        export PACKAGE_VERSION=$(jq -r .version package.json)

        # what's the Node.js version?
        export ABI=$(node --eval 'console.log(process.versions.modules)')

        # build inside the container and copy the package to the host
        docker build -t yara/debian .
        docker images

        # e.g. yara-v2.5.0-linux-x64-node-v93.tar.gz
        docker run --rm --volume /tmp:/tmp yara/debian cp ./binaries/yara-v${PACKAGE_VERSION}-linux-x64-node-v${ABI}.tar.gz /tmp
        ls -lh /tmp/yara-v${PACKAGE_VERSION}-*

        # copy it to the repository clone and see if there's a difference
        cp /tmp/yara-v${PACKAGE_VERSION}-* ./binaries
        git status  --porcelain

    # By default, the commit is made in the name of "GitHub Actions"
    # and co-authored by the user that made the last commit.
    # https://github.com/marketplace/actions/git-auto-commit
    - name: Commit the changes to the binary files
      # if: true  # node-gyp builds are not reproducible, hence each build would create a "new" commit -> disabling for now (comment out this line if needed)
      if: github.event_name == 'release' && github.event.action == 'created'  # commit new binaries package on releases
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        ref: ${{ github.head_ref }}  # https://github.com/marketplace/actions/git-auto-commit#checkout-the-correct-branch
        commit_message: Commit the binary package changes for Linux / Node.js ${{ matrix.node-version }}
        file_pattern: './binaries/*.tar.gz'


  build-macos:
    strategy:
      fail-fast: false
      matrix:
        node-version:
        - '16'
        - '18'
        - '20'

    runs-on: macos-12

    steps:
    - uses: actions/checkout@v3

    - name: Setup MacOs
      run: brew install autoconf automake libmagic

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@master
      with:
        node-version: ${{ matrix.node-version }}

    - name: Build binaries with node-pre-gyp
      run: |
        set -x
        npm install --ignore-scripts
        time -p npx node-pre-gyp configure rebuild

        otool -L build/Release/yara.node

        npx node-pre-gyp configure package

        cp ./build/stage/Automattic/node-yara/raw/master/binaries/yara-*.tar.gz ./binaries
        git status  --porcelain

    - name: Run tests
      run: npm test

    # By default, the commit is made in the name of "GitHub Actions"
    # and co-authored by the user that made the last commit.
    # https://github.com/marketplace/actions/git-auto-commit
    - name: Commit the changes to the binary files
      # if: true  # node-gyp builds are not reproducible, hence each build would create a "new" commit -> disabling for now (comment out this line if needed)
      if: github.event_name == 'release' && github.event.action == 'created'  # commit new binaries package on releases
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        ref: ${{ github.head_ref }}  # https://github.com/marketplace/actions/git-auto-commit#checkout-the-correct-branch
        commit_message: Commit the binary package changes for MacOS / Node.js ${{ matrix.node-version }}
        file_pattern: './binaries/*.tar.gz'
